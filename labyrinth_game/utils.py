# utils

import math

from .constants import ROOMS


def get_input(prompt="> "):
    """–°—á–∏—Ç—ã–≤–∞–µ—Ç –≤–≤–æ–¥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–π"""
    try:
        return input(prompt).strip()
    except (KeyboardInterrupt, EOFError):
        print("\n–í—ã—Ö–æ–¥ –∏–∑ –∏–≥—Ä—ã.")
        return "quit"


def pseudo_random(seed: int, modulo: int) -> int:
    """
    –ü—Ä–æ—Å—Ç–µ–π—à–∏–π –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º—ã–π –ø—Å–µ–≤–¥–æ—Å–ª—É—á–∞–π–Ω—ã–π –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä.
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ü–µ–ª–æ–µ —á–∏—Å–ª–æ –≤ –¥–∏–∞–ø–∞–∑–æ–Ω–µ [0, modulo).
    """
    x = math.sin(seed * 12.9898)
    x *= 43758.5453
    frac = x - math.floor(x)
    return int(frac * modulo)


def describe_current_room(game_state):
    """–í—ã–≤–æ–¥–∏—Ç –æ–ø–∏—Å–∞–Ω–∏–µ —Ç–µ–∫—É—â–µ–π –∫–æ–º–Ω–∞—Ç—ã"""
    current_room_name = game_state['current_room']
    room_data = ROOMS[current_room_name]

    # –ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã –≤ –≤–µ—Ä—Ö–Ω–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–µ
    print(f"\n== {current_room_name.upper()} ==")

    # –û–ø–∏—Å–∞–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã
    print(room_data['description'])

    # –í–∏–¥–∏–º—ã–µ –ø—Ä–µ–¥–º–µ—Ç—ã
    if room_data['items']:
        print("–ó–∞–º–µ—Ç–Ω—ã–µ –ø—Ä–µ–¥–º–µ—Ç—ã:", ", ".join(room_data['items']))

    # –î–æ—Å—Ç—É–ø–Ω—ã–µ –≤—ã—Ö–æ–¥—ã
    exits = ", ".join(room_data['exits'].keys())
    print("–í—ã—Ö–æ–¥—ã:", exits)

    # –°–æ–æ–±—â–µ–Ω–∏–µ –æ –∑–∞–≥–∞–¥–∫–µ
    if room_data['puzzle']:
        print("–ö–∞–∂–µ—Ç—Å—è, –∑–¥–µ—Å—å –µ—Å—Ç—å –∑–∞–≥–∞–¥–∫–∞ (–∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É solve).")


def solve_puzzle(game_state):
    """–ü–æ–∑–≤–æ–ª—è–µ—Ç –∏–≥—Ä–æ–∫—É —Ä–µ—à–∞—Ç—å –∑–∞–≥–∞–¥–∫—É –≤ —Ç–µ–∫—É—â–µ–π –∫–æ–º–Ω–∞—Ç–µ:
    - –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–æ–≤ —á–µ—Ä–µ–∑ puzzle['aliases']
    - –ø—Ä–∏–Ω–∏–º–∞–µ—Ç —Å–ª–æ–≤–µ—Å–Ω—É—é —Ñ–æ—Ä–º—É —á–∏—Å–ª–∞ (0..20) –µ—Å–ª–∏ –æ—Å–Ω–æ–≤–Ω–æ–π –æ—Ç–≤–µ—Ç ‚Äî —Ü–∏—Ñ—Ä—ã
    - –µ—Å–ª–∏ –Ω–µ–≤–µ—Ä–Ω—ã–π –æ—Ç–≤–µ—Ç –≤ 'trap_room', –≤—ã–∑—ã–≤–∞–µ—Ç trigger_trap(game_state)
    """
    current_room = game_state['current_room']
    room_data = ROOMS[current_room]

    puzzle = room_data.get('puzzle')

    # –ù–µ—Ç –∑–∞–≥–∞–¥–∫–∏ ‚Üí –≤—ã–≤–æ–¥–∏–º —Å–æ–æ–±—â–µ–Ω–∏–µ –∏ –≤—ã—Ö–æ–¥–∏–º
    if not puzzle:
        print("–ó–∞–≥–∞–¥–æ–∫ –∑–¥–µ—Å—å –Ω–µ—Ç.")
        return

    # –ü–µ—á–∞—Ç–∞–µ–º —Ç–µ–∫—Å—Ç –∑–∞–≥–∞–¥–∫–∏
    print("\n–ó–∞–≥–∞–¥–∫–∞:")
    print(puzzle['question'])

    # –ü–æ—Å—Ç—Ä–æ–∏–º –º–Ω–æ–∂–µ—Å—Ç–≤–æ –¥–æ–ø—É—Å—Ç–∏–º—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤
    accepted = set()

    main_answer = puzzle.get('answer')
    if main_answer is not None:
        accepted.add(str(main_answer).strip().lower())

        # –ï—Å–ª–∏ –æ—Å–Ω–æ–≤–Ω–æ–π –æ—Ç–≤–µ—Ç ‚Äî —Ü–∏—Ñ—Ä–æ–≤–∞—è —Å—Ç—Ä–æ–∫–∞, –¥–æ–±–∞–≤–∏–º —Ä—É—Å—Å–∫—É—é —Å–ª–æ–≤–µ—Å–Ω—É—é —Ñ–æ—Ä–º—É (0..20)
        try:
            n = int(str(main_answer).strip())
            # –Ω–µ–±–æ–ª—å—à–∞—è —Ç–∞–±–ª–∏—Ü–∞ –¥–ª—è 0..20 –Ω–∞ —Ä—É—Å—Å–∫–æ–º
            num_ru = {
                0: "–Ω–æ–ª—å", 1: "–æ–¥–∏–Ω", 2: "–¥–≤–∞", 3: "—Ç—Ä–∏", 4: "—á–µ—Ç—ã—Ä–µ",
                5: "–ø—è—Ç—å", 6: "—à–µ—Å—Ç—å", 7: "—Å–µ–º—å", 8: "–≤–æ—Å–µ–º—å", 9: "–¥–µ–≤—è—Ç—å",
                10: "–¥–µ—Å—è—Ç—å", 11: "–æ–¥–∏–Ω–Ω–∞–¥—Ü–∞—Ç—å", 12: "–¥–≤–µ–Ω–∞–¥—Ü–∞—Ç—å",
                13: "—Ç—Ä–∏–Ω–∞–¥—Ü–∞—Ç—å", 14: "—á–µ—Ç—ã—Ä–Ω–∞–¥—Ü–∞—Ç—å", 15: "–ø—è—Ç–Ω–∞–¥—Ü–∞—Ç—å",
                16: "—à–µ—Å—Ç–Ω–∞–¥—Ü–∞—Ç—å", 17: "—Å–µ–º–Ω–∞–¥—Ü–∞—Ç—å", 18: "–≤–æ—Å–µ–º–Ω–∞–¥—Ü–∞—Ç—å",
                19: "–¥–µ–≤—è—Ç–Ω–∞–¥—Ü–∞—Ç—å", 20: "–¥–≤–∞–¥—Ü–∞—Ç—å"
            }
            if n in num_ru:
                accepted.add(num_ru[n])
        except (TypeError, ValueError):
            # –Ω–µ —á–∏—Å–ª–æ ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞–µ–º
            pass

    # –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã (–µ—Å–ª–∏ –∑–∞–¥–∞–Ω—ã –≤ –¥–∞–Ω–Ω—ã—Ö)
    aliases = puzzle.get('aliases')
    if aliases and isinstance(aliases, (list, tuple, set)):
        for a in aliases:
            if isinstance(a, str):
                accepted.add(a.strip().lower())

    # –ü–æ–ª—É—á–∞–µ–º –æ—Ç–≤–µ—Ç –∏–≥—Ä–æ–∫–∞
    answer = get_input("–í–∞—à –æ—Ç–≤–µ—Ç: ").strip().lower()

    # –ü—Ä–æ–≤–µ—Ä–∫–∞
    if answer in accepted:
        print("–í–µ—Ä–Ω–æ! –í—ã —Ä–µ—à–∏–ª–∏ –∑–∞–≥–∞–¥–∫—É.")

        # –í—ã–¥–∞—ë–º –Ω–∞–≥—Ä–∞–¥—É, –µ—Å–ª–∏ –µ—Å—Ç—å
        reward = puzzle.get('reward')
        if reward:
            print(f"–í—ã –ø–æ–ª—É—á–∏–ª–∏: {reward}")
            game_state['player_inventory'].append(reward)

            # –ï—Å–ª–∏ –∑–∞–≥–∞–¥–∫–∞ —Å–≤—è–∑–∞–Ω–∞ —Å –æ—Ç–∫—Ä—ã—Ç–∏–µ–º —Å—É–Ω–¥—É–∫–∞ ‚Äî –ø–æ–±–µ–¥–∞
            if reward == "treasure_unlock":
                attempt_open_treasure(game_state)
                return

        # –£–¥–∞–ª—è–µ–º –∑–∞–≥–∞–¥–∫—É, —á—Ç–æ–±—ã –Ω–µ–ª—å–∑—è –±—ã–ª–æ —Ä–µ—à–∞—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω–æ
        room_data['puzzle'] = None

    else:
        print("–ù–µ–≤–µ—Ä–Ω–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.")
        # –û—Å–æ–±–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ: –µ—Å–ª–∏ —ç—Ç–æ trap_room ‚Äî —Ç—Ä–∏–≥–≥–µ—Ä–∏–º –ª–æ–≤—É—à–∫—É
        if current_room == "trap_room":
            # –≤—ã–∑—ã–≤–∞–µ–º trigger_trap (–æ–Ω–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞ –≤ —ç—Ç–æ–º –º–æ–¥—É–ª–µ)
            try:
                trigger_trap(game_state)
            except Exception as e:
                # –Ω–∞ —Å–ª—É—á–∞–π –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—ã—Ö –æ—à–∏–±–æ–∫ ‚Äî –∏–Ω—Ñ–æ—Ä–º–∏—Ä—É–µ–º, –Ω–æ –Ω–µ –ª–æ–º–∞–µ–º –∏–≥—Ä—É
                print("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–∏ –ª–æ–≤—É—à–∫–∏:", e)


def attempt_open_treasure(game_state):
    """
    –õ–æ–≥–∏–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è —Å–æ–∫—Ä–æ–≤–∏—â–Ω–∏—Ü—ã –∏ –ø–æ–±–µ–¥—ã.
    –ò–≥—Ä–æ–∫ –º–æ–∂–µ—Ç –ø–æ–±–µ–¥–∏—Ç—å –¥–≤—É–º—è —Å–ø–æ—Å–æ–±–∞–º–∏:
    - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å treasure_key –Ω–∞ —Å—É–Ω–¥—É–∫
    - –†–µ—à–∏—Ç—å –∑–∞–≥–∞–¥–∫—É, –æ—Ç–∫—Ä—ã–≤–∞—é—â—É—é —Å—É–Ω–¥—É–∫ (reward = 'treasure_unlock')
    """
    current_room = game_state['current_room']
    room_data = ROOMS[current_room]

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Å—É–Ω–¥—É–∫–∞
    if "treasure_chest" not in room_data.get("items", []):
        print("–ó–¥–µ—Å—å –Ω–µ—Ç —Å—É–Ω–¥—É–∫–∞.")
        return

    # –°—Ü–µ–Ω–∞—Ä–∏–π: —É –∏–≥—Ä–æ–∫–∞ –µ—Å—Ç—å –∫–ª—é—á
    if "treasure_key" in game_state["player_inventory"]:
        print("–í—ã –ø—Ä–∏–º–µ–Ω—è–µ—Ç–µ –∫–ª—é—á, –∏ –∑–∞–º–æ–∫ —â—ë–ª–∫–∞–µ—Ç. –°—É–Ω–¥—É–∫ –æ—Ç–∫—Ä—ã—Ç!")
        room_data["items"].remove("treasure_chest")
        print("–í —Å—É–Ω–¥—É–∫–µ —Å–æ–∫—Ä–æ–≤–∏—â–µ! üéâ –í—ã –ø–æ–±–µ–¥–∏–ª–∏!")
        game_state["game_over"] = True
        return

    # –°—Ü–µ–Ω–∞—Ä–∏–π: —Å—É–Ω–¥—É–∫ –º–æ–∂–Ω–æ –æ—Ç–∫—Ä—ã—Ç—å —Ä–µ—à–µ–Ω–∏–µ–º –∑–∞–≥–∞–¥–∫–∏
    if "treasure_unlock" in game_state["player_inventory"]:
        print("–ú–µ—Ö–∞–Ω–∏–∑–º –≤–Ω—É—Ç—Ä–∏ —Å—É–Ω–¥—É–∫–∞ —â—ë–ª–∫–∞–µ—Ç ‚Äî –∑–∞–≥–∞–¥–∫–∞ –æ—Ç–∫—Ä—ã–ª–∞ –µ–≥–æ!")
        room_data["items"].remove("treasure_chest")

        print("–í —Å—É–Ω–¥—É–∫–µ —Å–æ–∫—Ä–æ–≤–∏—â–µ! üéâ –í—ã –ø–æ–±–µ–¥–∏–ª–∏!")
        game_state["game_over"] = True
        return

    # –°—Ü–µ–Ω–∞—Ä–∏–π: –Ω–µ—Ç –∫–ª—é—á–∞ –∏ –Ω–∞–≥—Ä–∞–¥—ã
    print("–£ –≤–∞—Å –Ω–µ—Ç –∫–ª—é—á–∞, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å —Å—É–Ω–¥—É–∫.")
    choice = get_input("–•–æ—Ç–∏—Ç–µ –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –≤–≤–µ—Å—Ç–∏ –∫–æ–¥? (–¥–∞/–Ω–µ—Ç): ").strip().lower()
    if choice in ("–¥–∞", "yes", "y"):
        puzzle = room_data.get("puzzle")
        if puzzle:
            code = get_input("–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥: ").strip().lower()
            if code == puzzle["answer"].lower():
                print("–ö–æ–¥ –≤–µ—Ä–Ω—ã–π! –ó–∞–º–æ–∫ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è.")
                room_data["items"].remove("treasure_chest")
                print("–í —Å—É–Ω–¥—É–∫–µ —Å–æ–∫—Ä–æ–≤–∏—â–µ! üéâ –í—ã –ø–æ–±–µ–¥–∏–ª–∏!")
                game_state["game_over"] = True
            else:
                print("–ö–æ–¥ –Ω–µ–≤–µ—Ä–Ω—ã–π. –ó–∞–º–æ–∫ –æ—Å—Ç–∞—ë—Ç—Å—è –∑–∞–∫—Ä—ã—Ç—ã–º.")
        else:
            print("–í —Å—É–Ω–¥—É–∫–µ –Ω–µ—Ç –∑–∞–≥–∞–¥–∫–∏ –¥–ª—è –≤–∑–ª–æ–º–∞.")
    else:
        print("–í—ã –æ—Ç—Å—Ç—É–ø–∞–µ—Ç–µ –æ—Ç —Å—É–Ω–¥—É–∫–∞.")


def trigger_trap(game_state):
    """
    –°—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–µ –ª–æ–≤—É—à–∫–∏.
    - –ï—Å–ª–∏ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å –µ—Å—Ç—å ‚Üí —Å–ª—É—á–∞–π–Ω–æ —Ç–µ—Ä—è–µ–º –ø—Ä–µ–¥–º–µ—Ç.
    - –ï—Å–ª–∏ –ø—É—Å—Ç–æ–π ‚Üí —à–∞–Ω—Å –ø—Ä–æ–∏–≥—Ä–∞—Ç—å.
    """
    print("\n –õ–æ–≤—É—à–∫–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞! –ü–æ–ª –Ω–∞—á–∏–Ω–∞–µ—Ç –¥—Ä–æ–∂–∞—Ç—å...")

    inventory = game_state["player_inventory"]

    # –ï—Å–ª–∏ –µ—Å—Ç—å –ø—Ä–µ–¥–º–µ—Ç—ã ‚Üí –ø–æ—Ç–µ—Ä—è –ø—Ä–µ–¥–º–µ—Ç–∞
    if inventory:
        modulo = len(inventory)
        seed = game_state["steps_taken"]
        index = pseudo_random(seed, modulo)

        lost_item = inventory.pop(index)
        print(f"–í—ã –ø–æ—Ç–µ—Ä—è–ª–∏ –ø—Ä–µ–¥–º–µ—Ç: {lost_item}!")

        return

    # –ï—Å–ª–∏ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å –ø—É—Å—Ç ‚Üí —à–∞–Ω—Å –ø—Ä–æ–∏–≥—Ä–∞—Ç—å
    seed = game_state["steps_taken"]
    roll = pseudo_random(seed, 10)

    if roll < 3:
        print("–õ–æ–≤—É—à–∫–∞ —Å–º–µ—Ä—Ç–µ–ª—å–Ω–∞! –í—ã –ø–∞–¥–∞–µ—Ç–µ –≤ –ø—Ä–æ–ø–∞—Å—Ç—å...")
        game_state["game_over"] = True
    else:
        print("–í—ã —á—É–¥–æ–º —É—Ü–µ–ª–µ–ª–∏, —Ö–æ—Ç—å –∏ –Ω–µ–º–Ω–æ–≥–æ —Ä–∞—Å—Ç—Ä—ë–ø–∞–Ω—ã.")


def random_event(game_state):
    """
    –°–ª—É—á–∞–π–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è, –ø—Ä–æ–∏—Å—Ö–æ–¥—è—â–∏–µ –ø—Ä–∏ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–∏ –∏–≥—Ä–æ–∫–∞.
    –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –¥–≤–∏–∂–µ–Ω–∏—è.
    """
    seed = game_state["steps_taken"]

    # –®–∞–Ω—Å —Å–æ–±—ã—Ç–∏—è ~10% (–µ—Å–ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç == 0)
    if pseudo_random(seed, 10) != 0:
        return  # –Ω–∏—á–µ–≥–æ –Ω–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç

    # –í—ã–±–∏—Ä–∞–µ–º —Ç–∏–ø —Å–æ–±—ã—Ç–∏—è
    event_type = pseudo_random(seed + 1, 3)

    current_room = game_state["current_room"]
    room_data = ROOMS[current_room]

    # –°—Ü–µ–Ω–∞—Ä–∏–π 1: –ù–∞—Ö–æ–¥–∫–∞
    if event_type == 0:
        print("\n‚ú® –í—ã –Ω–∞—Ö–æ–¥–∏—Ç–µ –Ω–∞ –ø–æ–ª—É –º–æ–Ω–µ—Ç–∫—É!")
        room_data["items"].append("coin")
        return

    # –°—Ü–µ–Ω–∞—Ä–∏–π 2: –ò—Å–ø—É–≥
    if event_type == 1:
        print("\nüò® –í—ã —Å–ª—ã—à–∏—Ç–µ —Å—Ç—Ä–∞–Ω–Ω—ã–π —à–æ—Ä–æ—Ö –ø–æ–±–ª–∏–∑–æ—Å—Ç–∏...")
        if "sword" in game_state["player_inventory"]:
            print("–í—ã –≤—Å–∫–∏–¥—ã–≤–∞–µ—Ç–µ –º–µ—á, –∏ —Å—É—â–µ—Å—Ç–≤–æ —Å–∫—Ä—ã–≤–∞–µ—Ç—Å—è –≤ —Ç–µ–Ω–∏.")
        return

    # –°—Ü–µ–Ω–∞—Ä–∏–π 3: –õ–æ–≤—É—à–∫–∞
    if event_type == 2:
        if (
            current_room == "trap_room"
            and "torch" not in game_state["player_inventory"]
        ):
            print("\n–í—ã —á—É–≤—Å—Ç–≤—É–µ—Ç–µ –æ–ø–∞—Å–Ω–æ—Å—Ç—å... –ö–∞–∂–µ—Ç—Å—è, –∑–¥–µ—Å—å –ª–æ–≤—É—à–∫–∞!")
            trigger_trap(game_state)
        return


def show_help(COMMANDS):
    """–í—ã–≤–æ–¥–∏—Ç —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–æ–º–∞–Ω–¥ –¥–ª—è –∏–≥—Ä–æ–∫–∞."""
    print("\n–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:")

    for cmd, desc in COMMANDS.items():
        print(f"  {cmd:<16} - {desc}")